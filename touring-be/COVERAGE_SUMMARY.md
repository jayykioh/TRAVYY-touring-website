# Coverage summary (generated by Jest --coverage)

Snapshot (local run):

- Overall statements: 63.44%
- Branches: 50.65%
- Functions: 67.83%
- Lines: 65.23%

Key file-level metrics (highlights)

- `routes/discover.routes.js` — statements: 74.35% | branches: 56% | lines: 78.37% | uncovered: 18-21,25,58,101-102
- `routes/itinerary.routes.js` — statements: 30.4% | branches: 16.36% | lines: 31.44% | uncovered: large ranges (40-261,278,287,302,377-385,394-432,440-491,496-510,514-556)
- `services/ai/libs/embedding-client.js` — statements: 69.49% | branches: 54.83% | lines: 70.68% | uncovered: 20-24,57-58,83-84,128-129,140-141,153,176,200,209-210
- `services/ai/libs/llm.js` — statements: 57.97% | branches: 53.93% | lines: 61.27% | uncovered: 29-30,50,74-92,222-223,312-430
- `services/itinerary/optimizer.js` — statements: 74.48% | branches: 63.46% | lines: 75% | uncovered: ...74-175,188-198,209-215,233-249,266-272,395-396,409-414,440 (see detailed HTML)
- `services/zones/poi-finder.js` — statements: 51.96% | branches: 37.03% | lines: 53.12% | uncovered: 13-47,60,70,116-117,130-132,138-139,165-203
- `utils/gpx.js` — statements: 93.33% | branches: 43.75% | lines: 93.33% | uncovered: 7

Where the HTML report lives

- `coverage/lcov-report/index.html` — open this file in your browser for per-file, per-line detail and clickable navigation.
- `coverage/coverage-final.json` — machine-readable coverage details (already present in repository).

Explanation of uncovered code (short rationale & recommended actions)

- `routes/itinerary.routes.js`: many uncovered lines correspond to route handlers and orchestration logic (authorization, error branches, different parameter combinations, and third-party API interactions). Recommendation: add route tests that mock auth and the dependent services to exercise these handlers (happy path + error path). This will substantially raise the statements and branches numbers.

- `services/ai/libs/llm.js`: uncovered ranges include safety/schema validation branches, candidate-parsing fallbacks, and background-processing branches. Recommendation: add focused unit tests for these cases:
  - LLM returns empty `candidates` array
  - LLM returns content.parts with non-JSON text (malformed)
  - LLM times out (fake timers) — already partially covered; add negative and edge cases
  - Branches where heuristics add or remove keys

- `services/zones/poi-finder.js`: uncovered lines relate to polygon-based searches, map API pagination/limits, and certain dedupe/limit branches. Recommendation: add tests mocking map4d responses for edge cases (empty results, paginated responses, overlapping duplicates, distance edge cases).

- `services/ai/libs/embedding-client.js`: add negative tests for non-OK HTTP responses, invalid JSON shapes, and path variations (embed vs hybridSearch vs upsert) to cover remaining branches.

Is this 'enough' per typical submission requirements?

- If your requirement is an 80%+ overall statements coverage, then current coverage (63%) is not sufficient.
- If the requirement is to show a deterministic test suite (reproducible CI pass and documentation), the repo already satisfies that: tests are deterministic, CI workflow exists, coverage HTML is present. But increasing the percentage will require the targeted tests above.

Next steps I can take (pick one or more):

1. Add focused unit tests for `llm.js` deep branches (malformed JSON, empty candidate arrays, schema validation errors). — estimated 3–6 tests.
2. Add route tests for `itinerary.routes.js` (happy path + 2 error paths) using mocked Itinerary model and mocked optimizer functions. — estimated 3–5 tests.
3. Add coverage upload step for CI (Codecov) and a coverage badge in `README.md` (requires setting repo token in GitHub Secrets). — trivial edit to CI.

Tell me which next step you want me to take and I will implement it and re-run the tests.
