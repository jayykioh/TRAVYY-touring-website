# AI & Itinerary Flow - Class Diagram & Sequence Diagram

## 1. High-Level Architecture

```
+-------------------+         +-------------------+         +-------------------+
|   Frontend (FE)   | <-----> |   Backend (BE)    | <-----> |   AI/Embedding    |
|  React/Vite       |         | Node.js/Express   |         | FastAPI + FAISS   |
+-------------------+         +-------------------+         +-------------------+
```

## 2. Main Classes/Modules (Backend)

```
+-------------------+
|  ZoneService      |
+-------------------+
| +getZoneById()    |
| +findPOIsForZone()|
| +findPOIsByCategory()|
| +loadPriorityPOIs()|
+-------------------+
        |
        v
+-------------------+
|  POIFinder        |
+-------------------+
| +searchPOIsByText()|
| +searchPOIsByViewbox()|
| +searchPOIsNearby()|
| +getPlaceDetails()|
+-------------------+
        |
        v
+-------------------+
|  Map4D/Goong API  |
+-------------------+

+-------------------+
|  ItineraryService |
+-------------------+
| +createItinerary()|
| +addPOI()         |
| +optimizeAI()     |
| +savePolyline()   |
+-------------------+
        |
        v
+-------------------+
|  TripOptimizer    |
+-------------------+
| +tripV2()         |
| +callLLMAndParse()|
+-------------------+

+-------------------+
|  EmbeddingClient  |
+-------------------+
| +semanticSearch() |
+-------------------+
```

## 3. Sequence Diagram: Zone → POI → Itinerary → Optimize

```
User
 |
 | 1. Select zone, vibes
 v
Frontend (ZoneDetail.jsx)
 |
 |---> /api/zones/:zoneId/pois-priority
 |
 v
Backend (ZoneService)
 |---> POIFinder.findPOIsByCategory (for each category)
 |---> Map4D API (text-search/viewbox-search)
 |<--- POIs
 |
 |---> /api/zones/:zoneId/pois/:category (on tab click)
 |
 v
Frontend (User adds POI)
 |
 |---> /api/itinerary (POST)
 |---> /api/itinerary/:id/items (POST)
 |
 v
Backend (ItineraryService)
 |---> Save POI to itinerary
 |
 |---> /api/itinerary/:id/optimize-ai (POST)
 |
 v
TripOptimizer
 |---> tripV2 (Goong Trip API)
 |<--- route polyline, waypoints
 |---> callLLMAndParse (Gemini LLM)
 |<--- AI insights
 |---> Save optimized itinerary
 |
 v
Frontend (ItineraryResult.jsx)
 |---> Show timeline, map, AI tips
```

## 4. AI/Embedding Service (Python)

```
+-------------------+
|  app.py (FastAPI) |
+-------------------+
| +/embed           |
| +/upsert          |
| +/search          |
| +/stats           |
+-------------------+
        |
        v
+-------------------+
|  FAISS Index      |
+-------------------+
| +add/search       |
+-------------------+
```

## 5. Data Flow Summary

- User selects zone & vibes → FE calls BE for POIs (by category)
- BE queries Map4D/Goong API for POIs, filters by zone, returns to FE
- User adds POIs to itinerary → BE saves to MongoDB
- User clicks "Optimize" → BE calls Goong Trip API for route, Gemini LLM for AI tips
- FE displays optimized route, timeline, and AI insights

---

## 6. File/Module Mapping

- **Backend**
  - `services/zones/poi-finder.js` (POIFinder)
  - `services/zones/index.js` (ZoneService)
  - `services/ai/libs/map4d.js` (Map4D API)
  - `services/ai/libs/goong.js` (Goong API)
  - `services/embedding-client.js` (EmbeddingClient)
  - `services/itinerary/optimizer.js` (TripOptimizer)
  - `routes/zone.routes.js`, `routes/itinerary.routes.js`
- **Frontend**
  - `src/pages/ZoneDetail.jsx`
  - `src/components/Map4DPanel.jsx`, `POICategoryTabs.jsx`, `POISearch.jsx`
  - `src/pages/ItineraryResult.jsx`, `GoongMapLibre.jsx`
- **AI Service**
  - `ai/app.py` (FastAPI)
  - `ai/README.md` (API docs)

---

## 7. Sequence Example (POI Search)

```
User → FE: Chọn zone "Sơn Trà"
FE → BE: GET /api/zones/dn-son-tra/pois-priority
BE → Map4D: text-search "điểm tham quan" tại center zone
Map4D → BE: Trả về POIs
BE: Lọc POIs theo boundary, trả về FE
FE: Hiển thị markers, danh sách POI theo category
```

## 8. Sequence Example (Itinerary Optimize)

```
User → FE: Click "Tối ưu hành trình"
FE → BE: POST /api/itinerary/:id/optimize-ai
BE → Goong: tripV2(points)
Goong → BE: Trả về polyline, waypoints
BE → Gemini: Gửi prompt hành trình
Gemini → BE: Trả về insights
BE: Lưu polyline, insights, trả về FE
FE: Hiển thị route, timeline, AI tips
```

---

## 9. Notes
- Map4D/Goong API: POI discovery, route optimization
- Gemini LLM: AI insights, tips, summary
- Embedding Service: semantic search for zone/vibe matching
- All flows are async, FE uses React hooks for state

---

*Generated by Copilot - 2025-10-30* 
